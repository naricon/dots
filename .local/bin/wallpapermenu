#!/usr/bin/env bash

notify(){
    img=/tmp/palette.png
    mapfile -t colors < ~/.cache/wal/colors
    draw_cmds=()
    for row in 0 1; do
        for col in {0..7}; do
            idx=$((row * 8 + col))
            x1=$((col * 50))
            y1=$((row * 50))
            x2=$((x1 + 50))
            y2=$((y1 + 50))
            draw_cmds+=("-fill" "${colors[$idx]}" "-draw" "rectangle ${x1},${y1} ${x2},${y2}")
        done
    done
    magick -size 400x100 xc:none "${draw_cmds[@]}" "$img"

    notify-send -i $img "Pywal" "changed colors"
}

folder=~/media/pape/
script=refresh

wallpaper=$(nsxiv $folder -aotbrg 800x600+560+240)
[ -z "$wallpaper" ] && exit 0
backend=$(echo -e "wal\ncolorz\ncolorthief\nfast_colorthief\nmodern_colorthief\nhaishoku" | dmenu -c -l 6 -p "Select backend")
[ -z "$backend" ] && exit 0
style=$(echo -e "center\nfill\nmax\nscale\ntile" | dmenu -c -l 5 -p "Wallpaper style:")
[ -z "$style" ] && exit 0

wal -n -i "$wallpaper" --backend "$backend" -o $script --cols16
sleep 0.5
notify

case "$style" in
    center) feh --bg-center "$wallpaper" ;;
    fill) feh --bg-fill "$wallpaper" ;;
    max) feh --bg-max "$wallpaper" ;;
    scale) feh --bg-scale "$wallpaper" ;;
    tile) feh --bg-tile "$wallpaper" ;;
esac
